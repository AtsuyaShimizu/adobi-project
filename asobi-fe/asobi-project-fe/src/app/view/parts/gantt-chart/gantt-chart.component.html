<!-- NOTE: AGENTS.md の依存ルール遵守。View 役割内に限定した変更 -->
<div class="gantt-container" [class.ready]="isReady" (click)="closeFilterPopup()">
  <div class="gantt-main">
    <div class="scroll-host" #scrollHost>
      <table class="gantt-table">
      <thead>
        <!-- 1行目：左6列は実際に rowspan=2（タスクヘッダーは1セルで2行分） -->
        <tr class="head-1">
          <th class="h sticky-left col-type" rowspan="2">
            <span>タスク分類</span>
            <img
              src="sort.svg"
              alt="ソート"
              class="sort-icon"
              (click)="$event.stopPropagation(); toggleFilterPopup('type')"
            />
            @if (filterPopup === "type") {
              <div class="filter-popup" (click)="$event.stopPropagation()">
                <input
                  type="text"
                  class="filter-input"
                  [(ngModel)]="filters.type.keyword"
                />
                <div class="options">
                  @for (opt of getFilteredOptions("type"); track opt) {
                    <label>
                      <input
                        type="checkbox"
                        [checked]="filters.type.selected.has(opt)"
                        (change)="
                          onFilterChange('type', opt, $event.target.checked)
                        "
                      />
                      {{ opt }}
                    </label>
                  }
                </div>
              </div>
            }
          </th>
          <th class="h sticky-left col-name" rowspan="2">
            <span>タスク名</span>
            <img
              src="sort.svg"
              alt="ソート"
              class="sort-icon"
              (click)="$event.stopPropagation(); toggleFilterPopup('name')"
            />
            @if (filterPopup === "name") {
              <div class="filter-popup" (click)="$event.stopPropagation()">
                <input
                  type="text"
                  class="filter-input"
                  [(ngModel)]="filters.name.keyword"
                />
                <div class="options">
                  @for (opt of getFilteredOptions("name"); track opt) {
                    <label>
                      <input
                        type="checkbox"
                        [checked]="filters.name.selected.has(opt)"
                        (change)="
                          onFilterChange('name', opt, $event.target.checked)
                        "
                      />
                      {{ opt }}
                    </label>
                  }
                </div>
              </div>
            }
          </th>
          <th class="h sticky-left col-assignee" rowspan="2">
            <span>担当者</span>
            <img
              src="sort.svg"
              alt="ソート"
              class="sort-icon"
              (click)="$event.stopPropagation(); toggleFilterPopup('assignee')"
            />
            @if (filterPopup === "assignee") {
              <div class="filter-popup" (click)="$event.stopPropagation()">
                <input
                  type="text"
                  class="filter-input"
                  [(ngModel)]="filters.assignee.keyword"
                />
                <div class="options">
                  @for (opt of getFilteredOptions("assignee"); track opt) {
                    <label>
                      <input
                        type="checkbox"
                        [checked]="filters.assignee.selected.has(opt)"
                        (change)="
                          onFilterChange('assignee', opt, $event.target.checked)
                        "
                      />
                      {{ opt }}
                    </label>
                  }
                </div>
              </div>
            }
          </th>
          <th class="h sticky-left col-start" rowspan="2">開始日</th>
          <th class="h sticky-left col-end" rowspan="2">終了日</th>
          <th class="h sticky-left col-progress" rowspan="2">進捗率</th>

          @for (month of months; track month.label) {
            <th
              class="h month"
              [attr.colspan]="month.days"
              [style.backgroundColor]="monthColors[month.month - 1]"
            >
              {{ month.label }}
            </th>
          }
        </tr>

        <!-- 2行目：日付 -->
        <tr class="head-2">
          @for (date of dateRange; track date; let i = $index) {
            <th
              class="h date-col"
              [attr.data-idx]="i"
              [class.month-boundary]="isMonthStart(date) && i !== 0"
              (mouseenter)="onColumnMouseEnter(i)"
              (mouseleave)="onColumnMouseLeave()"
              [class.column-hover]="hoveredColIdx === i"
              [class.today]="isToday(date)"
              [class.weekend]="isWeekend(date)"
              [attr.title]="date | date: 'yyyy/MM/dd (EEE)'"
            >
              <div class="date-cell">
                <span class="d">{{ date | date: 'dd' }}</span>
                <span class="w">{{ date | date: 'EEE' }}</span>
              </div>
            </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of emptyRows; track $index; let i = $index) {
          @if (taskViews[i]; as view) {
            <tr>
              <td class="sticky-left col-type" (click)="onRowClick(view)">
                {{ view.task.type }}
              </td>
              <td class="sticky-left col-name" (click)="onRowClick(view)">
                {{ view.task.name }}
              </td>
              <td class="sticky-left col-assignee" (click)="onRowClick(view)">
                {{ view.task.assignee }}
              </td>
              <td class="sticky-left col-start" (click)="onRowClick(view)">
                {{ view.task.start | date: "yyyy-MM-dd" }}
              </td>
              <td class="sticky-left col-end" (click)="onRowClick(view)">
                {{ view.task.end | date: "yyyy-MM-dd" }}
              </td>
              <td class="sticky-left col-progress" (click)="onRowClick(view)">
                {{ view.task.progress }}%
              </td>

              @for (date of dateRange; track date; let j = $index) {
                <td
                  class="day"
                  (mousedown)="onCellMouseDown($event, i, j)"
                  (mouseenter)="onColumnMouseEnter(j)"
                  (mouseleave)="onColumnMouseLeave()"
                  (click)="startProgressEdit(view.task, i, j)"
                  [class.column-hover]="hoveredColIdx === j"
                  [class.focused]="isFocusedCell(i, j)"
                  [class.month-boundary]="isMonthStart(date) && j !== 0"
                  [class.today]="isToday(date)"
                  [class.weekend]="isWeekend(date)"
                  [attr.title]="date | date: 'yyyy/MM/dd (EEE)'"
                >
                  @if (isEditingCell(i, j)) {
                    <input
                      type="number"
                      class="progress-input"
                      [(ngModel)]="progressValue"
                      (keyup.enter)="commitProgress()"
                      (blur)="commitProgress()"
                      autofocus
                    />
                  }
                </td>
              }
            </tr>
          } @else {
            <tr>
              <td class="sticky-left col-type"></td>
              <td class="sticky-left col-name"></td>
              <td class="sticky-left col-assignee"></td>
              <td class="sticky-left col-start"></td>
              <td class="sticky-left col-end"></td>
              <td class="sticky-left col-progress"></td>

              @for (date of dateRange; track date; let j = $index) {
                <td
                  class="day"
                  (mousedown)="onCellMouseDown($event, i, j)"
                  (mouseenter)="onColumnMouseEnter(j)"
                  (mouseleave)="onColumnMouseLeave()"
                  [class.column-hover]="hoveredColIdx === j"
                  [class.focused]="isFocusedCell(i, j)"
                  [class.month-boundary]="isMonthStart(date) && j !== 0"
                  [class.today]="isToday(date)"
                  [class.weekend]="isWeekend(date)"
                  [attr.title]="date | date: 'yyyy/MM/dd (EEE)'"
                ></td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
    <div class="bar-layer">
      @for (bar of plannedBars; track bar.id) {
        <div class="ovl-plan" [style.left.px]="bar.left" [style.top.px]="bar.top" [style.width.px]="bar.width" [style.height.px]="bar.height" [class.start]="bar.start" [class.end]="bar.end"></div>
      }
      @for (bar of actualBars; track bar.id) {
        <div class="ovl-actual" [style.left.px]="bar.left" [style.top.px]="bar.top" [style.width.px]="bar.width" [style.height.px]="bar.height" [class.start]="bar.start" [class.end]="bar.end" [class.out-of-plan]="bar.outOfPlan"></div>
      }
    </div>
    <div class="memo-layer">
      @for (memo of memos; track memo.id) {
        <app-memo
          [memo]="memo"
          [editing]="editingMemoId === memo.id"
          (memoMouseDown)="onMemoMouseDown($event, memo)"
          (memoMouseUp)="onMemoMouseUp($event, memo)"
          (memoResizeMouseDown)="onMemoResizeMouseDown($event, memo)"
          (memoBlur)="onMemoBlur($event, memo)"
          (editToggle)="toggleEdit(memo, $event.el, $event.event)"
          (memoDelete)="onMemoDelete(memo.id)"
        ></app-memo>
      }
    </div>
    </div>
    <div class="v-scrollbar-wrapper">
      <div class="top-space"></div>
      <button class="v-span-nav up" (click)="scrollVerticalByPage(-1)" aria-label="上へ">
        <img src="arrow-left.svg" alt="" />
      </button>
      <div class="v-scrollbar" #vScrollbar (mousedown)="onVScrollbarMouseDown($event)">
        <div class="v-scrollbar-thumb" #vScrollbarThumb></div>
      </div>
      <button class="v-span-nav down" (click)="scrollVerticalByPage(1)" aria-label="下へ">
        <img src="arrow-right.svg" alt="" />
      </button>
    </div>
  </div>
  <div class="h-scrollbar-wrapper">
    <div class="left-space"></div>
    <button class="span-nav prev" (click)="moveSpan(-1)">
      <img src="arrow-left.svg" alt="前の期間" />
    </button>
    <div
      class="h-scrollbar"
      #hScrollbar
      (mousedown)="onScrollbarMouseDown($event)"
    >
      <div class="h-scrollbar-thumb" #hScrollbarThumb></div>
    </div>
    <button class="span-nav next" (click)="moveSpan(1)">
      <img src="arrow-right.svg" alt="次の期間" />
    </button>
  </div>
</div>
