<div class="gantt-container">
  <div class="header-wrapper" #headerHost>
    <table class="gantt-table">
      <thead>
        <!-- 1行目：左6列は実際に rowspan=2（タスクヘッダーは1セルで2行分） -->
        <tr class="head-1">
          <th class="h sticky-left col-type" rowspan="2">タスク分類</th>
          <th class="h sticky-left col-name" rowspan="2">タスク名</th>
          <th class="h sticky-left col-assignee" rowspan="2">担当者</th>
          <th class="h sticky-left col-start" rowspan="2">開始日</th>
          <th class="h sticky-left col-end" rowspan="2">終了日</th>
          <th class="h sticky-left col-progress" rowspan="2">進捗率</th>

          @for (month of months; track month.label) {
            <th class="h month" [attr.colspan]="month.days">{{ month.label }}</th>
          }
        </tr>

        <!-- 2行目：日付 -->
        <tr class="head-2">
          @for (date of dateRange; track date; let i = $index) {
            <th
              class="h date-col"
              [attr.data-idx]="i"
              [class.month-boundary]="isMonthStart(date) && i !== 0"
              (mouseenter)="onColumnMouseEnter(i)"
              (mouseleave)="onColumnMouseLeave()"
              [class.column-hover]="hoveredColIdx === i"
            >
              {{ date | date : 'dd' }}
            </th>
          }
        </tr>
      </thead>
    </table>
  </div>

  <!-- データ部分のみスクロール -->
  <div class="scroll-host" #scrollHost>
    <table class="gantt-table">
      <tbody>
        @for (row of emptyRows; track $index; let i = $index) {
          @if (tasks[i]; as task) {
            <tr (click)="onRowClick(task)">
              <td class="sticky-left col-type">{{ task.type }}</td>
              <td class="sticky-left col-name">{{ task.name }}</td>
              <td class="sticky-left col-assignee">{{ task.assignee }}</td>
              <td class="sticky-left col-start">{{ task.start | date : 'yyyy-MM-dd' }}</td>
              <td class="sticky-left col-end">{{ task.end | date : 'yyyy-MM-dd' }}</td>
              <td class="sticky-left col-progress">{{ task.progress }}%</td>

              @for (date of dateRange; track date; let j = $index) {
                <td
                  class="day"
                  (mousedown)="onCellMouseDown($event, i, j)"
                  (mouseenter)="onColumnMouseEnter(j)"
                  (mouseleave)="onColumnMouseLeave()"
                  [class.column-hover]="hoveredColIdx === j"
                  [class.focused]="isFocusedCell(i, j)"
                  [class.progress]="isProgress(task, date)"
                  [class.planned]="isPlanned(task, date)"
                  [class.progress-start]="isProgressStart(task, date)"
                  [class.progress-end]="isProgressEnd(task, date)"
                  [class.planned-start]="isPlannedStart(task, date)"
                  [class.planned-end]="isPlannedEnd(task, date)"
                  [class.month-boundary]="isMonthStart(date) && j !== 0"
                ></td>
              }
            </tr>
          } @else {
            <tr>
              <td class="sticky-left col-type"></td>
              <td class="sticky-left col-name"></td>
              <td class="sticky-left col-assignee"></td>
              <td class="sticky-left col-start"></td>
              <td class="sticky-left col-end"></td>
              <td class="sticky-left col-progress"></td>

              @for (date of dateRange; track date; let j = $index) {
                <td
                  class="day"
                  (mousedown)="onCellMouseDown($event, i, j)"
                  (mouseenter)="onColumnMouseEnter(j)"
                  (mouseleave)="onColumnMouseLeave()"
                  [class.column-hover]="hoveredColIdx === j"
                  [class.focused]="isFocusedCell(i, j)"
                  [class.month-boundary]="isMonthStart(date) && j !== 0"
                ></td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
    <div class="memo-layer">
      @for (memo of memos; track memo.id) {
        <app-memo
          [memo]="memo"
          [editing]="editingMemoId === memo.id"
          (memoMouseDown)="onMemoMouseDown($event, memo)"
          (memoMouseUp)="onMemoMouseUp($event, memo)"
          (memoResizeMouseDown)="onMemoResizeMouseDown($event, memo)"
          (memoBlur)="onMemoBlur($event, memo)"
          (editToggle)="toggleEdit(memo, $event.el, $event.event)"
        ></app-memo>
      }
    </div>
    <div class="h-scrollbar-mask"></div>
  </div>
</div>
